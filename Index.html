<script>
  let songs = [];
  let currentPage = 1;
  const pageSize = 10;
  let sortKey = "";
  let sortAsc = true;
  let apiUrl = ""; // é€™æ˜¯ Apps Script éƒ¨ç½²å¾Œçš„ç¶²å€

  // è¼”åŠ©å‡½å¼ï¼šç™¼é€ API è«‹æ±‚
  async function api(action, payload) {
    if (!apiUrl) {
      alert("è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ Apps Script éƒ¨ç½²ç¶²å€ï¼");
      return;
    }
    const response = await fetch(apiUrl, {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, payload })
    });
    return await response.json();
  }

  // ğŸš€ å¾ Google Sheet è¼‰å…¥æ­Œæ›²
  async function loadSongs() {
    const result = await api('getSongs');
    if (result.status === 'ok') {
      songs = result.data || [];
      render();
    } else {
      alert("è¼‰å…¥æ­Œæ›²å¤±æ•—ï¼š" + result.message);
    }
  }

  // ğŸ’¾ å„²å­˜æ­Œæ›²
  async function saveSong() {
    const song = {
      id: document.getElementById("songId").value,
      name: document.getElementById("songName").value.trim(),
      bpm: parseInt(document.getElementById("songBpm").value) || 0,
      lang: document.getElementById("songLang").value,
      style: document.getElementById("songStyle").value
    };
    if (!song.name) return alert("è«‹è¼¸å…¥æ­Œå");

    const result = await api('saveSong', song);
    if (result.status === "ok") {
      clearForm();
      loadSongs();
    } else if (result.status === "duplicate") {
      alert("âš ï¸ é€™é¦–æ­Œå·²ç¶“å­˜åœ¨ï¼Œè«‹å‹¿é‡è¤‡æ–°å¢ï¼");
    } else {
      alert("å„²å­˜å¤±æ•—ï¼š" + result.message);
    }
  }

  // âœï¸ ç·¨è¼¯æ­Œæ›²
  function editSong(id) {
    const song = songs.find(s => s.id === id);
    if (!song) return;
    document.getElementById("songId").value = song.id;
    document.getElementById("songName").value = song.name;
    document.getElementById("songBpm").value = song.bpm;
    document.getElementById("songLang").value = song.lang;
    document.getElementById("songStyle").value = song.style;
  }

  // ğŸ—‘ åˆªé™¤æ­Œæ›²
  async function deleteSong(id) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
    const result = await api('deleteSong', { id });
    if (result.status === "ok") {
      loadSongs();
    } else {
      alert("åˆªé™¤å¤±æ•—ï¼š" + result.message);
    }
  }

  // ğŸ§¹ æ¸…ç©ºè¡¨å–®
  function clearForm() {
    document.getElementById("songId").value = "";
    document.getElementById("songName").value = "";
    document.getElementById("songBpm").value = "";
    document.getElementById("songLang").value = "ä¸­æ–‡";
    document.getElementById("songStyle").value = "æƒ…æ­Œ";
  }

  // ğŸ¨ æ¸²æŸ“æ­Œæ›²æ¸…å–®ï¼ˆèˆ‡ä¹‹å‰ç›¸åŒï¼‰
  function render() {
    const search = document.getElementById("search").value.toLowerCase().trim();
    const filterLang = document.getElementById("filterLang").value.toLowerCase().trim();
    const filterStyle = document.getElementById("filterStyle").value.toLowerCase().trim();
    const filterBpm = document.getElementById("filterBpm").value;

    let filtered = songs.filter(s => {
      let ok = true;
      const name = (s.name || "").toLowerCase().trim();
      const lang = (s.lang || "").toLowerCase().trim();
      const style = (s.style || "").toLowerCase().trim();
      const bpm = Number(s.bpm) || 0;
      if (search && !(name.includes(search) || lang.includes(search) || style.includes(search))) ok = false;
      if (filterLang && lang !== filterLang) ok = false;
      if (filterStyle && style !== filterStyle) ok = false;
      if (filterBpm) {
        const [min, max] = filterBpm.split("â€“").map(Number);
        if (!(bpm >= min && bpm <= max)) ok = false;
      }
      return ok;
    });

    if (sortKey) {
      filtered.sort((a, b) => {
        if (a[sortKey] < b[sortKey]) return sortAsc ? -1 : 1;
        if (a[sortKey] > b[sortKey]) return sortAsc ? 1 : -1;
        return 0;
      });
    }

    const totalPages = Math.ceil(filtered.length / pageSize);
    if (currentPage > totalPages) currentPage = totalPages || 1;
    const start = (currentPage - 1) * pageSize;
    const pageData = filtered.slice(start, start + pageSize);
    const tbody = document.getElementById("songTable");
    tbody.innerHTML = "";
    pageData.forEach(s => {
      const row = `<tr>
        <td>${s.name}</td>
        <td>${s.bpm}</td>
        <td>${s.lang}</td>
        <td>${s.style}</td>
        <td>
          <button onclick="editSong('${s.id}')">âœï¸ ç·¨è¼¯</button>
          <button onclick="deleteSong('${s.id}')">ğŸ—‘ åˆªé™¤</button>
        </td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });

    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
      pagination.innerHTML += `<button onclick="gotoPage(${i})" ${i === currentPage ? "disabled" : ""}>${i}</button>`;
    }
  }

  function sortBy(key) {
    if (sortKey === key) sortAsc = !sortAsc;
    else { sortKey = key; sortAsc = true; }
    render();
  }

  function gotoPage(page) {
    currentPage = page;
    render();
  }

  window.onload = loadSongs;
</script>