<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    let songs = [];
    let currentPage = 1;
    const pageSize = 10;
    let sortKey = "";
    let sortAsc = true;
    
    // â­ è«‹å°‡ä½ çš„ Supabase URL å’Œ Key è²¼åœ¨é€™è£¡
    const SUPABASE_URL = 'https://qcvkwglzltebvajvyakm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjdmt3Z2x6bHRlYnZhanZ5YWttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzUwMjcsImV4cCI6MjA3MTYxMTAyN30.K1teLYiXQDquCcFKXX3ugdNfJCWqnik4XqQVQykr-go';
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ğŸš€ å¾ Supabase è¼‰å…¥æ­Œæ›²
    async function loadSongs() {
        const { data, error } = await supabase
            .from('songs')
            .select('*');
        
        if (error) {
            console.error('è¼‰å…¥æ­Œæ›²å¤±æ•—:', error);
            alert('è¼‰å…¥æ­Œæ›²å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Supabase è¨­å®šï¼');
        } else {
            songs = data || [];
            render();
        }
    }

    // ğŸ’¾ å„²å­˜æ­Œæ›²
    async function saveSong() {
        const songId = document.getElementById("songId").value;
        const songName = document.getElementById("songName").value.trim();
        const songBpm = parseInt(document.getElementById("songBpm").value) || 0;
        const songLang = document.getElementById("songLang").value;
        const songStyle = document.getElementById("songStyle").value;

        if (!songName) return alert("è«‹è¼¸å…¥æ­Œå");

        const newSong = {
            name: songName,
            bpm: songBpm,
            lang: songLang,
            style: songStyle
        };
        
        let result;
        if (songId) {
            result = await supabase
                .from('songs')
                .update(newSong)
                .eq('id', songId);
        } else {
            result = await supabase
                .from('songs')
                .insert(newSong);
        }

        if (result.error) {
            alert('å„²å­˜å¤±æ•—ï¼š' + result.error.message);
        } else {
            clearForm();
            loadSongs();
        }
    }

    // âœï¸ ç·¨è¼¯æ­Œæ›²
    function editSong(id) {
        const song = songs.find(s => s.id === id);
        if (!song) return;
        document.getElementById("songId").value = song.id;
        document.getElementById("songName").value = song.name;
        document.getElementById("songBpm").value = song.bpm;
        document.getElementById("songLang").value = song.lang;
        document.getElementById("songStyle").value = song.style;
    }

    // ğŸ—‘ åˆªé™¤æ­Œæ›²
    async function deleteSong(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
        
        const { error } = await supabase
            .from('songs')
            .delete()
            .eq('id', id);
        
        if (error) {
            alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
        } else {
            loadSongs();
        }
    }

    // ğŸ§¹ æ¸…ç©ºè¡¨å–®
    function clearForm() {
        document.getElementById("songId").value = "";
        document.getElementById("songName").value = "";
        document.getElementById("songBpm").value = "";
        document.getElementById("songLang").value = "ä¸­æ–‡";
        document.getElementById("songStyle").value = "æƒ…æ­Œ";
    }

    // ğŸ¨ æ¸²æŸ“æ­Œæ›²æ¸…å–®ï¼ˆèˆ‡ä¹‹å‰ç›¸åŒï¼‰
    function render() {
        const search = document.getElementById("search").value.toLowerCase().trim();
        const filterLang = document.getElementById("filterLang").value.toLowerCase().trim();
        const filterStyle = document.getElementById("filterStyle").value.toLowerCase().trim();
        const filterBpm = document.getElementById("filterBpm").value;

        let filtered = songs.filter(s => {
            let ok = true;
            const name = (s.name || "").toLowerCase().trim();
            const lang = (s.lang || "").toLowerCase().trim();
            const style = (s.style || "").toLowerCase().trim();
            const bpm = Number(s.bpm) || 0;
            if (search && !(name.includes(search) || lang.includes(search) || style.includes(search))) ok = false;
            if (filterLang && lang !== filterLang) ok = false;
            if (filterStyle && style !== filterStyle) ok = false;
            if (filterBpm) {
                const [min, max] = filterBpm.split("â€“").map(Number);
                if (!(bpm >= min && bpm <= max)) ok = false;
            }
            return ok;
        });

        if (sortKey) {
            filtered.sort((a, b) => {
                if (a[sortKey] < b[sortKey]) return sortAsc ? -1 : 1;
                if (a[sortKey] > b[sortKey]) return sortAsc ? 1 : -1;
                return 0;
            });
        }

        const totalPages = Math.ceil(filtered.length / pageSize);
        if (currentPage > totalPages) currentPage = totalPages || 1;
        const start = (currentPage - 1) * pageSize;
        const pageData = filtered.slice(start, start + pageSize);
        const tbody = document.getElementById("songTable");
        tbody.innerHTML = "";
        if (pageData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„æ­Œæ›²ã€‚</td></tr>`;
        } else {
            pageData.forEach(s => {
                const row = `<tr>
                    <td>${s.name}</td>
                    <td>${s.bpm}</td>
                    <td>${s.lang}</td>
                    <td>${s.style}</td>
                    <td>
                        <button onclick="editSong('${s.id}')">âœï¸ ç·¨è¼¯</button>
                        <button onclick="deleteSong('${s.id}')">ğŸ—‘ åˆªé™¤</button>
                    </td>
                </tr>`;
                tbody.insertAdjacentHTML("beforeend", row);
            });
        }

        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `<button onclick="gotoPage(${i})" ${i === currentPage ? "disabled" : ""}>${i}</button>`;
        }
    }

    function sortBy(key) {
        if (sortKey === key) sortAsc = !sortAsc;
        else { sortKey = key; sortAsc = true; }
        render();
    }

    function gotoPage(page) {
        currentPage = page;
        render();
    }

    window.onload = loadSongs;
</script>