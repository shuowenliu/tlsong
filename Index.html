<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>🎵 歌曲管理系統</title>
  <style>
    body {
      margin: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background: #222;
      color: #eee;
      display: flex;
      height: 100vh;
    }
    .left, .right {
      padding: 20px;
      overflow: auto;
      flex-shrink: 0;
    }
    .left {
      flex: 2;
      border-right: 2px solid #444;
    }
    .right {
      flex: 1;
      background: #333;
    }
    h2 {
      margin-top: 0;
      color: #ffcc00;
    }
    input, select {
      padding: 6px;
      margin: 4px;
      border: none;
      border-radius: 5px;
      background: #444;
      color: #fff;
    }
    button {
      padding: 8px 14px;
      margin: 4px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #ffcc00;
      color: #000;
      font-weight: bold;
    }
    button:hover { background: #ffaa00; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #555;
    }
    th {
      cursor: pointer;
      color: #ffcc00;
    }
    tr:hover { background: #444; }
    .filters {
      margin-bottom: 10px;
    }
    .pagination { text-align: center; margin-top: 10px; }
    .pagination button {
      background: #666;
      color: #fff;
    }
    .pagination button:disabled {
      background: #ffcc00;
      color: #000;
    }
    @media (max-width: 768px) {
      body {
        flex-direction: column;
        height: auto;
      }
      .left, .right {
        flex: 1;
        width: 100%;
        border-right: none;
        border-bottom: 2px solid #444;
      }
      .filters {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .filters input, .filters select {
        flex: 1 1 auto;
        min-width: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="left">
    <h2>📋 歌曲清單</h2>
    <div class="filters">
      <input type="text" id="search" placeholder="🔍 關鍵字搜尋...">
      <select id="filterLang">
        <option value="">全部語言</option>
        <option>中文</option>
        <option>英文</option>
        <option>日文</option>
        <option>韓文</option>
        <option>越南</option>
        <option>粵語</option>
        <option>台語</option>
      </select>
      <select id="filterStyle">
        <option value="">全部型態</option>
        <option>情歌</option>
        <option>悲傷</option>
        <option>嗨歌</option>
        <option>RAP</option>
        <option>抒情</option>
      </select>
      <select id="filterBpm">
        <option value="">全部速度</option>
        <option value="61-70">61–70</option>
        <option value="71-80">71–80</option>
        <option value="81-90">81–90</option>
        <option value="91-100">91–100</option>
        <option value="101-110">101–110</option>
        <option value="111-120">111–120</option>
        <option value="121-130">121–130</option>
        <option value="131-140">131–140</option>
        <option value="141-150">141–150</option>
        <option value="151-160">151–160</option>
        <option value="161-170">161–170</option>
        <option value="171-180">171–180</option>
        <option value="181-190">181–190</option>
        <option value="191-200">191–200</option>
        <option value="201-250">201–250</option>
      </select>
    </div>
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('name')">歌名</th>
          <th onclick="sortBy('bpm')">速度</th>
          <th onclick="sortBy('lang')">語言</th>
          <th onclick="sortBy('style')">型態</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="songTable"></tbody>
    </table>
    <div class="pagination" id="pagination"></div>
  </div>

  <div class="right">
    <h2>✍️ 新增 / 編輯歌曲</h2>
    <input type="hidden" id="songId">
    <p><input id="songName" placeholder="歌名"></p>
    <p><input id="songBpm" type="number" placeholder="BPM"></p>
    <p>
      <select id="songLang">
        <option>中文</option>
        <option>英文</option>
        <option>日文</option>
        <option>韓文</option>
        <option>越南</option>
        <option>粵語</option>
        <option>台語</option>
      </select>
    </p>
    <p>
      <select id="songStyle">
        <option>情歌</option>
        <option>悲傷</option>
        <option>嗨歌</option>
        <option>RAP</option>
        <option>抒情</option>
      </select>
    </p>
    <button id="saveSongBtn">💾 儲存</button>
    <button id="clearFormBtn">🧹 清除</button>

    <hr style="border-color:#555; margin: 20px 0;">
    <h2>📤 CSV 匯入</h2>
    <p>
      <input type="file" id="csvFile" accept=".csv" style="padding: 10px;">
    </p>
    <button id="importCsvBtn">🚀 匯入歌曲</button>
    <p id="importStatus" style="font-size:12px;"></p>
  </div>

  <!-- 載入 Supabase 與 PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    let songs = [];
    let currentPage = 1;
    const pageSize = 10;
    let sortKey = "";
    let sortAsc = true;

    // ⭐ Supabase 設定
    const SUPABASE_URL = 'https://qcvkwglzltebvajvyakm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjdmt3Z2x6bHRlYnZhanZ5YWttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzUwMjcsImV4cCI6MjA3MTYxMTAyN30.K1teLYiXQDquCcFKXX3ugdNfJCWqnik4XqQVQykr-go'; // ⚠️ 換成 Supabase anon public key

    if (!SUPABASE_KEY || SUPABASE_KEY === '你的 anon key') {
      alert("⚠️ 請先到 Supabase 後台複製 'anon public key'，貼到 SUPABASE_KEY！");
      throw new Error("Supabase key not set");
    }

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // 🚀 載入歌曲
    async function loadSongs() {
      const { data, error } = await supabaseClient.from('songs').select('*');
      if (error) {
        console.error('載入歌曲失敗:', error);
        alert('載入歌曲失敗，請檢查 Supabase 設定！');
      } else {
        songs = data || [];
        render();
      }
    }

    // 匯入 CSV
    async function importCsv() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      if (!file) return alert('請選擇一個 CSV 檔案！');

      const importStatus = document.getElementById('importStatus');
      importStatus.textContent = "正在讀取檔案...";

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async function(results) {
          const dataToInsert = results.data.map(row => ({
            name: row.name,
            bpm: parseInt(row.bpm) || 0,
            lang: row.lang,
            style: row.style
          }));

          if (dataToInsert.length === 0) {
            alert('CSV 檔案中沒有找到任何歌曲資料。');
            importStatus.textContent = "";
            return;
          }

          importStatus.textContent = `找到 ${dataToInsert.length} 筆資料，開始匯入...`;
          for (const [index, row] of dataToInsert.entries()) {
            const { error } = await supabaseClient.from('songs').insert([row]);
            if (error) {
              importStatus.textContent = `匯入失敗於第 ${index + 1} 筆：${error.message}`;
              console.error('匯入錯誤:', error);
              return;
            }
            importStatus.textContent = `匯入進度：${index + 1} / ${dataToInsert.length} 筆...`;
          }

          importStatus.textContent = `成功匯入 ${dataToInsert.length} 筆歌曲！`;
          loadSongs();
          fileInput.value = '';
        }
      });
    }

    // 儲存歌曲
    async function saveSong() {
      const songId = document.getElementById("songId").value;
      const songName = document.getElementById("songName").value.trim();
      const songBpm = parseInt(document.getElementById("songBpm").value) || 0;
      const songLang = document.getElementById("songLang").value;
      const songStyle = document.getElementById("songStyle").value;
      if (!songName) return alert("請輸入歌名");

      const newSong = { name: songName, bpm: songBpm, lang: songLang, style: songStyle };
      let result;
      if (songId) {
        result = await supabaseClient.from('songs').update(newSong).eq('id', songId);
      } else {
        result = await supabaseClient.from('songs').insert(newSong);
      }
      if (result.error) alert('儲存失敗：' + result.error.message);
      else { clearForm(); loadSongs(); }
    }

    function editSong(id) {
      const song = songs.find(s => s.id === id);
      if (!song) return;
      document.getElementById("songId").value = song.id;
      document.getElementById("songName").value = song.name;
      document.getElementById("songBpm").value = song.bpm;
      document.getElementById("songLang").value = song.lang;
      document.getElementById("songStyle").value = song.style;
    }

    async function deleteSong(id) {
      if (!confirm("確定要刪除嗎？")) return;
      const { error } = await supabaseClient.from('songs').delete().eq('id', id);
      if (error) alert('刪除失敗：' + error.message);
      else loadSongs();
    }

    function clearForm() {
      document.getElementById("songId").value = "";
      document.getElementById("songName").value = "";
      document.getElementById("songBpm").value = "";
      document.getElementById("songLang").value = "中文";
      document.getElementById("songStyle").value = "情歌";
    }

    // 🔎 修正版篩選邏輯
    function render() {
      const search = document.getElementById("search").value.toLowerCase().trim();
      const filterLang = document.getElementById("filterLang").value.toLowerCase().trim();
      const filterStyle = document.getElementById("filterStyle").value.toLowerCase().trim();
      const filterBpm = document.getElementById("filterBpm").value;

      let filtered = songs.filter(s => {
        let ok = true;
        const name = (s.name || "").toLowerCase().trim();
        const lang = (s.lang || "").toLowerCase().trim();
        const style = (s.style || "").toLowerCase().trim();
        const bpm = Number(s.bpm) || 0;

        if (search && !(name.includes(search) || lang.includes(search) || style.includes(search))) ok = false;
        if (filterLang && !lang.includes(filterLang)) ok = false;
        if (filterStyle && !style.includes(filterStyle)) ok = false;
        if (filterBpm) {
          const [min, max] = filterBpm.split("–").map(Number);
          if (!(bpm >= min && bpm <= max)) ok = false;
        }
        return ok;
      });

      if (sortKey) {
        filtered.sort((a, b) => {
          if (a[sortKey] < b[sortKey]) return sortAsc ? -1 : 1;
          if (a[sortKey] > b[sortKey]) return sortAsc ? 1 : -1;
          return 0;
        });
      }

      const totalPages = Math.ceil(filtered.length / pageSize);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      const start = (currentPage - 1) * pageSize;
      const pageData = filtered.slice(start, start + pageSize);

      const tbody = document.getElementById("songTable");
      tbody.innerHTML = pageData.length
        ? pageData.map(s => `
          <tr>
            <td>${s.name}</td>
            <td>${s.bpm}</td>
            <td>${s.lang}</td>
            <td>${s.style}</td>
            <td>
              <button onclick="editSong('${s.id}')">✏️ 編輯</button>
              <button onclick="deleteSong('${s.id}')">🗑 刪除</button>
            </td>
          </tr>`).join("")
        : `<tr><td colspan="5">查無符合條件的歌曲。</td></tr>`;

      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `<button onclick="gotoPage(${i})" ${i === currentPage ? "disabled" : ""}>${i}</button>`;
      }
    }

    function sortBy(key) {
      if (sortKey === key) sortAsc = !sortAsc;
      else { sortKey = key; sortAsc = true; }
      render();
    }

    function gotoPage(page) {
      currentPage = page;
      render();
    }

    document.getElementById("saveSongBtn").onclick = saveSong;
    document.getElementById("clearFormBtn").onclick = clearForm;
    document.getElementById("importCsvBtn").onclick = importCsv;

    document.getElementById("search").addEventListener("input", render);
    document.getElementById("filterLang").addEventListener("change", render);
    document.getElementById("filterStyle").addEventListener("change", render);
    document.getElementById("filterBpm").addEventListener("change", render);

    window.onload = loadSongs;
  </script>
</body>
</html>

